import{j as a,c as l}from"./locales-548059eb.js";import{r as h}from"./react-libs-840bfe49.js";import{d as $,i as q,e as R,b as J,p as y}from"./base-1da74170.js";import{a as b}from"./index-59db7e48.js";import{c as K}from"./interceptor-35467a90.js";import{I as Q}from"./Image-d312b6e1.js";import{L as W}from"./Loading-c60598b2.js";import{C as z}from"./ConfigProviderContext-0f984393.js";import{g as E}from"./unit-bb3e6514.js";import{I as Y}from"./index-091c3a1d.js";function L(e){return Array.isArray(e)?e:[e]}function D(e,d){return new Promise(f=>{if(d==="file"){f();return}const t=new FileReader;t.onload=u=>{f(u.target.result)},d==="dataUrl"?t.readAsDataURL(e):d==="text"&&t.readAsText(e)})}function S(e,d){return L(e).some(f=>f.file?$(d)?d(f.file):f.file.size>d:!1)}function Z(e,d){const f=[],t=[];return e.forEach(u=>{S(u,d)?t.push(u):f.push(u)}),{valid:f,invalid:t}}const p=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg)/i;function ee(e){return p.test(e)}function O(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?ee(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}const ne=e=>{const{prefixCls:d,createNamespace:f}=h.useContext(z),[t]=f("uploader",d),u=()=>{const{status:r,message:m}=e.item;if(r==="uploading"||r==="failed"){const I=r==="failed"?a.jsx(b,{name:"close",className:l(t("mask-icon"))}):a.jsx(W,{className:l(t("loading"))}),j=q(m)&&m!=="";return a.jsxs("div",{className:l(t("mask")),children:[I,j&&a.jsx("div",{className:l(t("mask-message")),children:m})]})}return null},C=r=>{const{name:m,item:I,index:j,beforeDelete:k}=e;r.stopPropagation(),K({interceptor:k,args:[I,{name:m,index:j}],done:()=>{var N;return(N=e.onDelete)==null?void 0:N.call(e)}})},g=()=>{e.onPreview&&e.onPreview()},v=()=>e.deletable&&e.item.status!=="uploading"?a.jsx("div",{className:l(t("preview-delete")),onClick:C,children:a.jsx(b,{name:"cross",className:l(t("preview-delete-icon"))})}):null,x=()=>{if(e.previewCoverRender){const{index:r,item:m}=e;return a.jsx("div",{className:l(t("preview-cover")),children:e.previewCoverRender(R({index:r},m))})}return null},P=()=>{const{item:r}=e;return O(r)?a.jsx(Q,{fit:e.imageFit,src:r.content||r.url,className:l(t("preview-image")),width:e.previewSize,height:e.previewSize,onClick:g,children:x()}):a.jsxs("div",{className:l(t("file")),style:E(e.previewSize),children:[a.jsx(b,{className:l(t("file-icon")),name:"description"}),a.jsx("div",{className:l(t("file-name"),"rc-ellipsis"),children:r.file?r.file.name:r.url}),x()]})};return a.jsxs("div",{className:l(t("preview")),onClick:e.onClick,children:[P(),u(),v()]})},M=h.forwardRef((e,d)=>{const{prefixCls:f,createNamespace:t}=h.useContext(z),[u]=t("uploader",f),C=h.useRef(null),g=h.useRef(),v=(n=(e==null?void 0:e.value.length)||0)=>({name:e.name,index:n}),x=()=>{g.current&&(g.current.value="")},P=n=>{var i,s,c;if(x(),S(n,e.maxSize))if(Array.isArray(n)){const o=Z(n,e.maxSize);if(n=o.valid,(i=e.onOversize)==null||i.call(e,o.invalid,v()),!n.length)return}else{(s=e.onOversize)==null||s.call(e,n,v());return}(c=e.onChange)==null||c.call(e,[...e.value,...L(n)]),e.afterRead&&e.afterRead(n,v())},r=n=>{const{maxCount:i,value:s,resultType:c}=e;if(Array.isArray(n)){const o=+i-s.length;n.length>o&&(n=n.slice(0,o)),Promise.all(n.map(w=>D(w,c))).then(w=>{const B=n.map((H,A)=>{const F={file:H,status:"",message:""};return w[A]&&(F.content=w[A]),F});P(B)})}else D(n,c).then(o=>{const w={file:n,status:"",message:""};o&&(w.content=o),P(w)})},m=n=>{const{files:i}=n.target;if(e.disabled||!i||!i.length)return;const s=i.length===1?i[0]:[].slice.call(i);if(e.beforeRead){const c=e.beforeRead(s,v());if(!c){x();return}if(J(c)){c.then(o=>{r(o||s)}).catch(x);return}}r(s)},I=()=>{e.onClosePreview&&e.onClosePreview()},j=n=>{if(e.previewFullImage){const i=e.value.filter(O),s=i.map(c=>c.content||c.url).filter(Boolean);C.current=Y.open(R({images:s,startPosition:i.indexOf(n),onClose:I},e.previewOptions))}},k=()=>{C.current&&C.current.close()},N=(n,i)=>{var c,o;const s=e.value.slice(0);s.splice(i,1),(c=e.onChange)==null||c.call(e,s),(o=e.onDelete)==null||o.call(e,n,v(i))},T=(n,i)=>{const s=["imageFit","deletable","previewSize","beforeDelete"],c=R(y(e,s),y(n,s,!0));return a.jsx(ne,{item:n,index:i,previewCoverRender:e.previewCoverRender,onClick:()=>{e.onClickPreview&&e.onClickPreview(n,v(i))},onDelete:()=>N(n,i),onPreview:()=>j(n),...y(e,["name"]),...c},i)},V=()=>e.previewImage?e.value.map(T):null,U=n=>{e.onClickUpload&&e.onClickUpload(n)},X=()=>typeof e.uploadIcon=="string"?a.jsx(b,{name:e.uploadIcon,className:l(u("upload-icon"))}):h.isValidElement(e.uploadIcon)?e.uploadIcon:null,_=()=>{if(e.value.length>=e.maxCount||!e.showUpload)return null;const n=e.readonly?null:a.jsx("input",{ref:g,type:"file",className:l(u("input")),accept:e.accept,capture:e.capture,multiple:e.multiple,disabled:e.disabled,onChange:m});return e.children?a.jsxs("div",{className:l(u("input-wrapper")),onClick:U,children:[e.children,n]}):a.jsxs("div",{className:l(u("upload",{readonly:e.readonly})),style:E(e.previewSize),onClick:U,children:[X(),e.uploadText&&a.jsx("span",{className:l(u("upload-text")),children:e.uploadText}),n]})},G=()=>{g.current&&!e.disabled&&g.current.click()};return h.useImperativeHandle(d,()=>({chooseFile:G,closeImagePreview:k})),a.jsx("div",{className:l(u()),children:a.jsxs("div",{className:l(u("wrapper",{disabled:e.disabled})),children:[V(),_()]})})});M.defaultProps={maxSize:Number.MAX_VALUE,maxCount:Number.MAX_VALUE,deletable:!0,showUpload:!0,previewImage:!0,previewFullImage:!0,name:"",accept:"image/*",value:[],imageFit:"cover",resultType:"dataUrl",uploadIcon:"photograph"};const fe=M;export{fe as U,L as t};
